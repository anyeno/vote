<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投票页面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <style>
        * {
          padding: 0;
          margin: 0;
        }     
        body {
          background-image: url(../../images/壁纸3.jpg);
          background-size: cover;
        }
        .row{
          margin: 5vh auto;
        }
</style>
<body>
  <div class="card container " style="margin: 5vh auto; background-color: rgb(232, 232, 232);">
    <div class="card-body" style="height: 80vh;">
      <div class="container text-center">
          <div class="row">
            <h2>请选择你投票的选项</h2>
            <h3 id="error_msg" style="color: red"></h3>
          </div>
          <table class="table table-success table-striped" style="width: 50vw; margin: 0 auto; height: 50vh">
            <thead>
              <tr>
                <th scope="col"> <h5>编号</h5></th>
                <th scope="col"><h5>选项</h5></th>
                <th scope="col"><h5>确认</h5></th>
                <th scope="col"><h5>得票数</h5></th>
              </tr>
            </thead>

            <tbody class="" id="item">
              <!-- <tr>
                <th scope="row">1</th>
                <td>Mark</td>
                <td>Otto</td>
              </tr> -->
              
            </tbody>
          </table>
            
      </div>
    </div>
  </div>
    
</body>

<script>
  let noptions = 0;
  let data = [];
  function getQueryVariable(variable){
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
        if(pair[0] == variable){return pair[1];}
    }
    return(false);
}
  let channel_id = getQueryVariable("channel_id");
  let vote_id = getQueryVariable("vote_id");
  console.log("channel_id" + channel_id + " vote_id" + vote_id);
  let token = window.localStorage.getItem("token")
  function vote(id) {
    console.log("vote")
    $.ajax({
      url: "http://127.0.0.1:3000/user/vote",
      type: "GET",
      headers:{
        'Content-Type':'application/json;charset=utf8',
        "token": token
      },
      data:{
        id: id,
      },
      success(resp) {
        console.log(resp)
        if(resp.message == "投票成功"){
          window.location.href ="投票成功.html"
        } else {
          console.log(resp.message)
          let error = resp.message
          $("#error_msg").text(error)
        }
      },
      error() {
        console.log("error")
      }
    })
  }
  function getOptions() {
    $.ajax({
      url: "http://127.0.0.1:3000/free/getAllOption",
      type: "GET",
      data: {
        channel_id: channel_id,
        vote_id: vote_id,
      },
      success(resp){
        console.log(resp)
        data = resp.data;
        noptions = data.length;
        append_item();
      }
    })
  }
  getOptions();
  function append_item() { 
    let to_be_append = ``;
    for (let i = 0; i < noptions; i ++) {
      let id = data[i]["id"];
      let count = data[i]["voteCount"];
      // to_be_append += `
      //   <div calss="item">
      //       <h2>${data[i]["name"]}</h2>
      //       <div class="forhim" href="投票成功.html" style="margin-top: 5px;"  onclick="vote(`+id+`)">为他投票</div>
      //       <h3 >得票数: ${count}</h3> 
      //   </div>
      //   `
      to_be_append += `<tr>
                <th scope="row"><h5>${i}</h5></th>
                <td><h5 >${data[i]["name"]} </h5></td>
                <td><div class="forhim" href="投票成功.html" style="margin-top: 5px;"  onclick="vote(`+id+`)"><input id="z1" type="button" class="btn btn-primary" value="为他投票" style="width:80%;height:100%"></div></td>
                <td>${count}</td>
              </tr>`
    }
    console.log(to_be_append)
    $("#item").append(to_be_append);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
</html>